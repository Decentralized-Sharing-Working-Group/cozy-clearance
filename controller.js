// Generated by CoffeeScript 1.7.1
var Contact, CozyAdapter, americano, async, clearance, e,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

clearance = require('./index');

async = require('async');

americano = require('americano-cozy');

Contact = americano.getModel('Contact', {
  fn: String,
  n: String,
  datapoints: function(x) {
    return x;
  }
});

CozyAdapter = (function() {
  try {
    return require('americano-cozy/node_modules/jugglingdb-cozy-adapter');
  } catch (_error) {
    e = _error;
    return require('jugglingdb-cozy-adapter');
  }
})();

module.exports = function(options) {
  var mailSubject, mailTemplate, out, sendMail;
  out = {};
  mailSubject = options.mailSubject;
  mailTemplate = options.mailTemplate;
  sendMail = function(doc, key, cb) {
    var rule;
    rule = doc.clearance.filter(function(rule) {
      return rule.key === key;
    })[0];
    return doc.getPublicURL((function(_this) {
      return function(err, url) {
        var mailOptions;
        if (err) {
          return cb(err);
        }
        url += '?key=' + rule.key;
        mailOptions = {
          to: rule.email,
          subject: mailSubject({
            doc: doc,
            url: url
          }),
          content: url,
          html: mailTemplate({
            doc: doc,
            url: url
          })
        };
        return CozyAdapter.sendMailFromUser(mailOptions, cb);
      };
    })(this));
  };
  out.add = function(req, res, next) {
    var autosend, contactid, email, _ref;
    _ref = req.body, email = _ref.email, contactid = _ref.contactid, autosend = _ref.autosend;
    return clearance.add(req.doc, 'r', {
      email: email,
      contactid: contactid
    }, function(err, key) {
      if (err) {
        return next(err);
      }
      if (!autosend || autosend === 'false') {
        return res.send(req.doc);
      } else {
        req.body.key = key;
        return out.send(req, res, next);
      }
    });
  };
  out.revoke = function(req, res, next) {
    var key;
    key = req.body.key;
    return clearance.revoke(req.doc, {
      key: key
    }, function(err) {
      if (err) {
        return next(err);
      }
      return res.send(req.doc);
    });
  };
  out.send = function(req, res, next) {
    var key;
    key = req.body.key;
    return sendMail(req.doc, key, function(err) {
      var newrules;
      if (err) {
        return next(err);
      }
      newrules = req.doc.clearance.map(function(rule) {
        if (rule.key === key) {
          rule.sent = true;
        }
        return rule;
      });
      return req.doc.updateAttributes({
        clearance: newrules
      }, function(err) {
        if (err) {
          return next(err);
        }
        return res.send(req.doc);
      });
    });
  };
  out.change = function(req, res, next) {
    clearance = req.body.clearance;
    return req.doc.updateAttributes({
      clearance: clearance
    }, function(err) {
      if (err) {
        return next(err);
      }
      return res.send(req.doc);
    });
  };
  out.sendAll = function(req, res, next) {
    var sent, toSend;
    toSend = req.body;
    sent = [];
    return async.each(toSend, function(rule, cb) {
      sent.push(rule.key);
      return sendMail(req.doc, rule.key, cb);
    }, function(err) {
      var newClearance;
      if (err) {
        return next(err);
      }
      newClearance = req.doc.clearance.map(function(rule) {
        var _ref;
        if (_ref = rule.key, __indexOf.call(sent, _ref) >= 0) {
          rule.sent = true;
        }
        return rule;
      });
      return req.doc.updateAttributes({
        clearance: newClearance
      }, function(err) {
        if (err) {
          return next(err);
        }
        return res.send(req.doc);
      });
    });
  };
  out.contactList = function(req, res, next) {
    return Contact.request('all', function(err, contacts) {
      if (err) {
        return next(err);
      }
      return res.send(contacts.map(function(contact) {
        var emails, name, simple, _ref, _ref1;
        name = contact.fn || ((_ref = contact.n) != null ? _ref.split(';').slice(0, 2).join(' ') : void 0);
        emails = (_ref1 = contact.datapoints) != null ? _ref1.filter(function(dp) {
          return dp.name === 'email';
        }) : void 0;
        emails = emails.map(function(dp) {
          return dp.value;
        });
        return simple = {
          id: contact.id,
          name: name || '?',
          emails: emails || []
        };
      }));
    });
  };
  return out;
};
