require.register("cozy-clearance/contact_autocomplete",function(e,t,n){n.exports=function(e,n,r){var i;return i=t("./contact_collection"),null==r&&(r=function(){return!0}),e.on("keyup",function(t){return 13!==t.which||e.data("typeahead").shown?void 0:(n(e.val()),e.val(""),t.preventDefault())}),e.typeahead({source:function(e){var t,n,o;return o=new RegExp(e,"i"),t=i.filter(function(e){return e.match(o)}),n=[],t.forEach(function(e){return e.get("emails").forEach(function(t){return n.push({id:e.id,hasPicture:e.get("hasPicture"),display:e.get("name")+" &lt;"+t+"&gt;",toString:function(){return t+";"+e.id}})})}),n=n.filter(r)},matcher:function(e){var t;return t=$.fn.typeahead.Constructor.prototype.matcher,t.call(this,e.display)},sorter:function(e){var t,n,r,i,o;for(t=[],r=[],n=[];i=e.shift();)o=i.display,o.toLowerCase().indexOf(this.query.toLowerCase())?~o.indexOf(this.query)?r.push(i):n.push(i):t.push(i);return t.concat(r,n)},highlighter:function(e){var t,n;return n=$.fn.typeahead.Constructor.prototype.highlighter,t=e.hasPicture?'<img width="40" src="clearance/contacts/'+e.id+'.jpg">&nbsp;':'<img width="40" src="images/defaultpicture.png">&nbsp;',t+n.call(this,e.display)},updater:function(e){return n(e),""}})}}),require.register("cozy-clearance/contact_collection",function(e,t,n){var r,i,o=function(e,t){function n(){this.constructor=e}for(var r in t)s.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},s={}.hasOwnProperty;i=new Backbone.Collection,i.url="clearance/contacts",i.model=r=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return o(t,e),t.prototype.urlRoot="clearance/contacts",t.prototype.match=function(e){return e.test(this.get("name"))||this.get("emails").some(function(t){return e.test(t)})},t}(Backbone.Model),i.fetch(),i.handleRealtimeContactEvent=function(e){var t,n,o,s;if(t=e.doctype,s=e.operation,n=e.id,"contact"!==t)return null;switch(s){case"create":return o=new r({id:n}),o.fetch({success:function(e){return i.add(o)}});case"update":return o=i.get(n),o.fetch();case"delete":return o=i.get(n),i.remove(o)}},n.exports=i}),require.register("cozy-clearance/modal",function(e,n,r){var i,o=function(e,t){return function(){return e.apply(t,arguments)}},s=function(e,t){function n(){this.constructor=e}for(var r in t)a.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},a={}.hasOwnProperty;i=function(e){function t(){return this.closeOnEscape=o(this.closeOnEscape,this),t.__super__.constructor.apply(this,arguments)}return s(t,e),t.prototype.id="modal-dialog",t.prototype.className="modal fade",t.prototype.attributes={"data-backdrop":"static","data-keyboard":"false"},t.prototype.initialize=function(e){return null==this.title&&(this.title=e.title),null==this.content&&(this.content=e.content),null==this.yes&&(this.yes=e.yes||"ok"),null==this.no&&(this.no=e.no||"cancel"),null==this.cb&&(this.cb=e.cb||function(){}),this.render(),this.saving=!1,this.$el.modal("show"),this.$("button.close").click(function(e){return function(t){return t.stopPropagation(),e.onNo()}}(this)),$(document).on("keyup",this.closeOnEscape)},t.prototype.events=function(){return{"click #modal-dialog-no":"onNo","click #modal-dialog-yes":"onYes",click:"onClickAnywhere"}},t.prototype.onNo=function(){return this.close(),this.cb(!1)},t.prototype.onYes=function(){return this.close(),this.cb(!0)},t.prototype.close=function(){return this.closing?void 0:(this.closing=!0,this.$el.modal("hide"),setTimeout(function(e){return function(){return e.remove()}}(this),500))},t.prototype.closeOnEscape=function(e){return 27===e.which?this.onNo():void 0},t.prototype.remove=function(){return $(document).off("keyup",this.closeOnEscape),t.__super__.remove.apply(this,arguments)},t.prototype.render=function(){var e,t,n,r,i,o,s;return t=$('<button class="close" type="button" data-dismiss="modal" aria-hidden="true">Ã—</button>'),o=$('<h4 class="model-title">').text(this.title),i=$('<div class="modal-header">').append(t,o),e=$('<div class="modal-body">').append(this.renderContent()),s=$('<button id="modal-dialog-yes" class="btn btn-cozy">').text(this.yes),r=$('<div class="modal-footer">').append(s),this.no&&r.prepend($('<button id="modal-dialog-no" class="btn btn-link">').text(this.no)),n=$('<div class="modal-content">').append(i,e,r),n=$('<div class="modal-dialog">').append(n),$("body").append(this.$el.append(n))},t.prototype.renderContent=function(){return this.content},t.prototype.onClickAnywhere=function(e){return e.target.id===this.id?this.onNo():void 0},t}(Backbone.View),i.alert=function(e,t,n){return new i({title:e,content:t,yes:"ok",no:null,cb:n})},i.confirm=function(e,t,n,r,o){return new i({title:e,content:t,yes:n,no:r,cb:o})},i.error=function(e,n){return new i({title:t("modal error"),content:e,yes:t("modal ok"),no:!1,cb:n})},r.exports=i}),require.register("cozy-clearance/modal_share_template",function(e,n,r){function i(e){var n,r=[],i=e||{};return function(e,t,i,o,s,a,c,l,u){r.push('<div><div id="select-mode-section"><p>'+jade.escape(null==(n=c("modal question "+l+" shareable",{name:s.get("name")}))?"":n)+'</p><p><button id="share-public" class="button btn-cozy">'+jade.escape(null==(n=c("shared"))?"":n)+'</button>&nbsp;<button id="share-private" class="button btn-cozy">'+jade.escape(null==(n=c("private"))?"":n)+'</button>&nbsp;<button id="share-micropub" class="button btn-cozy">'+jade.escape(null==(n=c("micropub"))?"":n)+'</button></p></div><p>&nbsp;</p></div><div class="micropub"><t modal shared micropub msg="modal shared micropub msg"></t><input id="micropub-input" type="text"'+jade.attr("placeholder",c("Enter the micropub url"),!0,!1)+' autocomplete="off" class="form-control"/><a id="indieauth" class="btn btn-cozy">Authenticate with indieauth</a><a id="micropub" class="btn btn-cozy">Share</a></div><!-- If no clearance are set, we consider it\'s a private object.-->'),"[]"==e.stringify(i)?r.push("<p>"+jade.escape(null==(n=c("only you can see"))?"":n)+"</p>"):(r.push('<div class="public-url"><p>'+jade.escape(null==(n=c("modal shared public link msg"))?"":n)+"</p>"),"public"==i?r.push('<input id="public-url"'+jade.attr("value",o(),!0,!1)+' class="form-control"/>'):r.push('<input id="public-url"'+jade.attr("value",o(),!0,!1)+' class="form-control disabled"/>'),r.push('<p>&nbsp;</p></div><p><span class="public-url">'+jade.escape(null==(n=c("or"))?"":n)+"</span>&nbsp;"+jade.escape(null==(n=c("modal shared with people msg"))?"":n)+'</p><form role="form" class="input-group"><input id="share-input" type="text"'+jade.attr("placeholder",c("modal shared "+l+" custom msg"),!0,!1)+' autocomplete="off" class="form-control"/><a id="add-contact" class="btn btn-cozy">Add</a></form><ul id="share-list">'),"public"!=i&&function(){var e=i;if("number"==typeof e.length)for(var s=0,l=e.length;l>s;s++){var p=e[s];if(p!=u){var h=p.key;r.push('<li class="clearance-line">'),p.contact?(p.contact.get("hasPicture")?r.push('<img width="40"'+jade.attr("src","clearance/contacts/"+p.contact.id+".jpg",!0,!1)+"/>&nbsp;"):r.push('<img width="40" src="images/defaultpicture.png"/>&nbsp;'),r.push('<span class="clearance-name">'+jade.escape(null==(n=p.contact.get("name"))?"":n)+"</span>")):r.push('<img width="40" src="images/defaultpicture.png"/><span class="clearance-name">'+jade.escape(null==(n=p.email)?"":n)+"</span>");var d=t.keys(a);d.length>1?(r.push("<select"+jade.attr("data-key",h,!0,!1)+' class="changeperm">'),function(){var e=a;if("number"==typeof e.length)for(var t=0,i=e.length;i>t;t++){var o=e[t];r.push("<option"+jade.attr("value",t,!0,!1)+jade.attr("selected",p.perm==t,!0,!1)+">"+jade.escape(null==(n=" "+c("perm")+c(o))?"":n)+"</option>")}else{var i=0;for(var t in e){i++;var o=e[t];r.push("<option"+jade.attr("value",t,!0,!1)+jade.attr("selected",p.perm==t,!0,!1)+">"+jade.escape(null==(n=" "+c("perm")+c(o))?"":n)+"</option>")}}}.call(this),r.push("</select>")):r.push(jade.escape(null==(n=" "+c("perm")+a[d[0]])?"":n)),r.push("<a"+jade.attr("data-key",h,!0,!1)+jade.attr("title",c("revoke"),!0,!1)+' class="clearance-btn pull-right revoke"><i class="fa fa-trash"></i></a><a'+jade.attr("data-key",h,!0,!1)+jade.attr("title",c("see link"),!0,!1)+jade.attr("href",o(h),!0,!1)+' class="clearance-btn pull-right show-link"><i class="fa fa-link"></i></a></li>')}}else{var l=0;for(var s in e){l++;var p=e[s];if(p!=u){var h=p.key;r.push('<li class="clearance-line">'),p.contact?(p.contact.get("hasPicture")?r.push('<img width="40"'+jade.attr("src","clearance/contacts/"+p.contact.id+".jpg",!0,!1)+"/>&nbsp;"):r.push('<img width="40" src="images/defaultpicture.png"/>&nbsp;'),r.push('<span class="clearance-name">'+jade.escape(null==(n=p.contact.get("name"))?"":n)+"</span>")):r.push('<img width="40" src="images/defaultpicture.png"/><span class="clearance-name">'+jade.escape(null==(n=p.email)?"":n)+"</span>");var d=t.keys(a);d.length>1?(r.push("<select"+jade.attr("data-key",h,!0,!1)+' class="changeperm">'),function(){var e=a;if("number"==typeof e.length)for(var t=0,i=e.length;i>t;t++){var o=e[t];r.push("<option"+jade.attr("value",t,!0,!1)+jade.attr("selected",p.perm==t,!0,!1)+">"+jade.escape(null==(n=" "+c("perm")+c(o))?"":n)+"</option>")}else{var i=0;for(var t in e){i++;var o=e[t];r.push("<option"+jade.attr("value",t,!0,!1)+jade.attr("selected",p.perm==t,!0,!1)+">"+jade.escape(null==(n=" "+c("perm")+c(o))?"":n)+"</option>")}}}.call(this),r.push("</select>")):r.push(jade.escape(null==(n=" "+c("perm")+a[d[0]])?"":n)),r.push("<a"+jade.attr("data-key",h,!0,!1)+jade.attr("title",c("revoke"),!0,!1)+' class="clearance-btn pull-right revoke"><i class="fa fa-trash"></i></a><a'+jade.attr("data-key",h,!0,!1)+jade.attr("title",c("see link"),!0,!1)+jade.attr("href",o(h),!0,!1)+' class="clearance-btn pull-right show-link"><i class="fa fa-link"></i></a></li>')}}}}.call(this),r.push("</ul>"))}.call(this,"JSON"in i?i.JSON:"undefined"!=typeof JSON?JSON:void 0,"Object"in i?i.Object:"undefined"!=typeof Object?Object:void 0,"clearance"in i?i.clearance:"undefined"!=typeof clearance?clearance:void 0,"makeURL"in i?i.makeURL:"undefined"!=typeof makeURL?makeURL:void 0,"model"in i?i.model:"undefined"!=typeof model?model:void 0,"possible_permissions"in i?i.possible_permissions:"undefined"!=typeof possible_permissions?possible_permissions:void 0,"t"in i?i.t:"undefined"!=typeof t?t:void 0,"type"in i?i.type:"undefined"!=typeof type?type:void 0,"undefined"in i?i.undefined:void 0),r.join("")}r.exports=i}),require.register("cozy-clearance/modal_share_view",function(e,n,r){var i,o,s,a,c,l,u,p,h=function(e,t){return function(){return e.apply(t,arguments)}},d=function(e,t){function n(){this.constructor=e}for(var r in t)f.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},f={}.hasOwnProperty;o=n("./modal"),c=n("./contact_autocomplete"),a=n("./contact_collection"),l=function(e){var t;for(null==e&&(e=32),t="";t.length<e;)t+=Math.random().toString(36).substr(2);return t.substr(0,e)},s=function(e,t){return"public"===e?[]:"public"===t?e:e.filter(function(e){return!_.findWhere(t,{key:e.key})})},u=function(e,t,n,r){var i;return i={method:e,url:t,dataType:"json",data:JSON.stringify(n),contentType:"application/json; charset=utf-8"},$.ajax(_.extend(i,r))},p=function(e,t,n,r){var i;return i={method:e,url:t,dataType:"json",data:n,contentType:"application/json; charset=utf-8"},$.ajax(_.extend(i,r))},r.exports=i=function(e){function r(){return this.onClose=h(this.onClose,this),this.onYes=h(this.onYes,this),this.onNo=h(this.onNo,this),this.revoke=h(this.revoke,this),this.onGuestAdded=h(this.onGuestAdded,this),this.getClearanceWithContacts=h(this.getClearanceWithContacts,this),this.existsEmail=h(this.existsEmail,this),this.typeaheadFilter=h(this.typeaheadFilter,this),this.makeURL=h(this.makeURL,this),this.getRenderData=h(this.getRenderData,this),r.__super__.constructor.apply(this,arguments)}return d(r,e),r.prototype.id="cozy-clearance-modal",r.prototype.template_content=n("./modal_share_template"),r.prototype.events=function(){return _.extend(r.__super__.events.apply(this,arguments),{"click #share-public":"makePublic","click #share-private":"makePrivate","click #share-micropub":"makeMicropub","click #indieauth":"indieAuth","click #micropub":"micropub","click #modal-dialog-share-save":"onSave","click .revoke":"revoke","click .show-link":"showLink","click #add-contact":"onAddClicked","change select.changeperm":"changePerm"})},r.prototype.permissions=function(){return{r:t("r")}},r.prototype.initialize=function(e){return this.cb=this.onClose,this.model=e.model,this.model.set("clearance",this.model.get("clearance")||[]),this.initState=JSON.parse(JSON.stringify(this.model.get("clearance"))),this.title=t("sharing"),this.yes=t("save"),this.no=t("cancel"),r.__super__.initialize.apply(this,arguments)},r.prototype.getRenderData=function(){return{type:this.model.get("type"),model:this.model,clearance:this.getClearanceWithContacts(),makeURL:this.makeURL,possible_permissions:this.permissions(),t:t,isMicropub:this.isMicropub}},r.prototype.render=function(){return r.__super__.render.call(this),$(".email-hint").remove(),$(".modal-footer").prepend($("<span class='pull-left email-hint'>"+t("send email hint")+"</span>"))},r.prototype.renderContent=function(){return $("<p>Please wait</p>")},r.prototype.afterRender=function(){var e;return e=this.model.get("clearance")||[],this._checkToggleButtonState(e),this._configureTypeAhead(e),this._firstFocus(e),this.isMicropub()?(this.$(".public-url").hide(),$(".email-hint").hide(),void $(".micropub").show()):this.isPublicClearance()?(this.$(".public-url").show(),$(".email-hint").hide(),$(".micropub").hide()):(this.$(".public-url").hide(),$(".micropub").hide(),this.isPrivateClearance()?$(".email-hint").hide():$(".email-hint").show())},r.prototype._checkToggleButtonState=function(e){return this.isPrivateClearance?this.$("#share-private").addClass("toggled"):this.isPublicClearance?this.isMicropub()?this.$("#share-micropub").addClass("toggled"):this.$("#share-public").addClass("toggled"):void 0},r.prototype._configureTypeAhead=function(e){var t;return"object"!=typeof e||e.length>0?(t=this.$("#share-input"),c(t,this.onGuestAdded,this.typeaheadFilter)):void 0},r.prototype._firstFocus=function(e){return setTimeout(function(t){return function(){return t.isPublicClearance()?t.$("#public-url").focus().select():e.length>0?t.$("input#share-input").select():void 0}}(this),200)},r.prototype.refresh=function(){return this.$(".modal-body").html(this.template_content(this.getRenderData())),this.afterRender()},r.prototype.makePublic=function(){return null!=this.lastClearance?this.model.set({clearance:this.lastClearance}):this.model.set({clearance:"public"}),this.refresh()},r.prototype.makeMicropub=function(){return this.model.set({micropub:!0}),this.refresh()},r.prototype.makePrivate=function(){return this.isPublicClearance()?(this.lastClearance=this.model.get("clearance"),this.model.set({clearance:[]}),this.refresh()):void 0},r.prototype.makeURL=function(e){var t;return console.log("key : "+e),t=this.model.getPublicURL(),e&&(t+="?key="+e),e&&this.saveKey(e),t},r.prototype.typeaheadFilter=function(e){return!this.existsEmail(e.toString().split(";")[0])},r.prototype.existsEmail=function(e){return _.some(this.model.get("clearance"),function(t){return t.email===e})},r.prototype.getClearanceWithContacts=function(e){return null==e&&(e=this.model.get("clearance")||[]),"object"==typeof e&&(e=e.map(function(e){var t;return t=_.clone(e),t.contactid&&(t.contact=a.get(e.contactid)),t})),e},r.prototype.doSave=function(e,n){return u("PUT","clearance/"+this.model.id,this.saveData(),{error:function(){return o.error(t("server error occured"))},success:function(r){return function(i){return r.model.trigger("change",r.model),e?u("POST","clearance/"+r.model.id+"/send",n,{error:function(e,n){return-1!==e.responseText.indexOf("postfix-")?o.error(t("postfix error")):o.error(t("mail not sent"))},success:function(e){return r.$el.modal("hide")}}):r.$el.modal("hide")}}(this)})},r.prototype.saveData=function(){return{clearance:this.model.get("clearance")}},r.prototype.showLink=function(e){var n,r,i,o,s;return r=$(e.target).parents("li"),0===r.find(".linkshow").length?(i=$(e.currentTarget),o=i.prop("href"),r=$('<div class="linkshow">'),n=$("<label>").text(t("copy paste link")),s=$('<input type="text">').val(o),i.parents("li").append(r.append(n,s)),s.focus().select(),e.preventDefault()):r.find(".linkshow").remove(),!1},r.prototype.isPublicClearance=function(){return"public"===this.model.get("clearance")},r.prototype.isPrivateClearance=function(){var e;return e=this.model.get("clearance"),"object"==typeof e&&0===e.length},r.prototype.isMicropub=function(){return this.model.get("micropub")===!0},r.prototype.onAddClicked=function(){return this.onGuestAdded(this.$("#share-input").val())},r.prototype.onGuestAdded=function(e){var t,n,r,i,o,s,a;return a=e.split(";"),r=a[0],n=a[1],i=""===r||r.indexOf("@")<1,this.existsEmail(r)||i?null:(o=l(),s="r",t=this.isPublicClearance()?[]:this.model.get("clearance"),t.push({contactid:n,email:r,key:o,perm:s}),this.model.set({clearance:t}),this.refresh())},r.prototype.revoke=function(e){var t;return t=this.model.get("clearance").filter(function(t){return t.key!==e.currentTarget.dataset.key}),0===t.length?this.model.set({clearance:"public"}):this.model.set({clearance:t}),this.refresh()},r.prototype.changePerm=function(e){var t;return t=e.currentTarget,this.model.get("clearance").filter(function(e){return e.key===t.dataset.key})[0].perm=t.options[t.selectedIndex].value,this.refresh()},r.prototype.onNo=function(){var e,n,i,a;return e=this.model.get("clearance"),i=0!==s(e,this.initState).length,n=e.length!==this.initState.length,a=i||n,a?o.confirm(t("confirm"),t("share confirm save"),t("yes"),t("no"),function(e){return function(t){return t?r.__super__.onNo.apply(e,arguments):void 0}}(this)):r.__super__.onNo.apply(this,arguments)},r.prototype.onYes=function(){var e,n;return e=this.model.get("clearance"),n=0!==s(e,this.initState).length,this.$("#share-input").val()&&!n?o.confirm(t("confirm"),t("share forgot add"),t("no forgot"),t("yes forgot"),function(e){return function(t){return t?r.__super__.onYes.apply(e,arguments):void 0}}(this)):r.__super__.onYes.apply(this,arguments)},r.prototype.onClose=function(e){var n,r;return e?(n=s(this.model.get("clearance"),this.initState),n.length?(r=t("send mails question")+n.map(function(e){return e.email}).join(", "),o.confirm(t("modal send mails"),r,t("yes"),t("no"),function(e){return function(t){return e.doSave(t,n)}}(this))):this.doSave(!1)):this.model.set({clearance:this.initState})},r.prototype.indieAuth=function(){var e;return this.model.set({micropub:!0}),e={url:this.getMicropubURL,id:this.model.id},p("GET","clearance/indieauth",e,{error:function(e,n){return console.log("data : "+JSON.stringify(e)),console.log("response : "+JSON.stringify(n)),o.error(t(JSON.stringify(n)))},success:function(e){return function(e){return console.log("success data : "+JSON.stringify(e)),window.location.replace(e)}}(this)})},r.prototype.micropub=function(){return p("GET","clearance/photos",this.getKey(),{error:function(e,n){return o.error(t(JSON.stringify(n)))},success:function(e){return console.log("data : "+JSON.stringify(e)),console.log("micropub go"),p("GET","clearance/micropub",e,{error:function(e,n){return console.log("data : "+JSON.stringify(e)),console.log("response : "+JSON.stringify(n)),o.error(t(JSON.stringify(n)))},success:function(e){return function(e){return console.log("success !")}}(this)})}})},r.prototype.getMicropubURL=function(){return this.$("#micropub-input").val()},r.prototype.getKey=function(){return console.log("key : "+this.model.get("key")),{key:this.model.get("key")}},r.prototype.saveKey=function(e){return console.log("key saved : "+e),this.model.set({key:e})},r}(o)}),require.register("cozy-clearance/modal_share_view",function(e,n,r){var i,o,s,a,c,l,u,p,h=function(e,t){return function(){return e.apply(t,arguments)}},d={}.hasOwnProperty,f=function(e,t){function n(){this.constructor=e}for(var r in t)d.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};o=n("./modal"),c=n("./contact_autocomplete"),a=n("./contact_collection"),l=function(e){var t;for(null==e&&(e=32),t="";t.length<e;)t+=Math.random().toString(36).substr(2);return t.substr(0,e)},s=function(e,t){return"public"===e?[]:"public"===t?e:e.filter(function(e){return!_.findWhere(t,{key:e.key})})},u=function(e,t,n,r){var i;return i={method:e,url:t,dataType:"json",data:JSON.stringify(n),contentType:"application/json; charset=utf-8"},$.ajax(_.extend(i,r))},p=function(e,t,n,r){var i;return i={method:e,url:t,dataType:"json",data:n,contentType:"application/json; charset=utf-8"},$.ajax(_.extend(i,r))},r.exports=i=function(e){function r(){return this.onClose=h(this.onClose,this),this.onYes=h(this.onYes,this),this.onNo=h(this.onNo,this),this.revoke=h(this.revoke,this),this.onGuestAdded=h(this.onGuestAdded,this),this.getClearanceWithContacts=h(this.getClearanceWithContacts,this),this.existsEmail=h(this.existsEmail,this),this.typeaheadFilter=h(this.typeaheadFilter,this),this.makeURL=h(this.makeURL,this),this.getRenderData=h(this.getRenderData,this),r.__super__.constructor.apply(this,arguments)}return f(r,e),r.prototype.id="cozy-clearance-modal",r.prototype.template_content=n("./modal_share_template"),r.prototype.events=function(){return _.extend(r.__super__.events.apply(this,arguments),{"click #share-public":"makePublic","click #share-private":"makePrivate","click #share-micropub":"makeMicropub","click #indieauth":"indieAuth","click #micropub":"micropub","click #modal-dialog-share-save":"onSave","click .revoke":"revoke","click .show-link":"showLink","click #add-contact":"onAddClicked","change select.changeperm":"changePerm"})},r.prototype.permissions=function(){return{r:t("r")}},r.prototype.initialize=function(e){return this.cb=this.onClose,this.model=e.model,this.model.set("clearance",this.model.get("clearance")||[]),this.initState=JSON.parse(JSON.stringify(this.model.get("clearance"))),this.title=t("sharing"),this.yes=t("save"),this.no=t("cancel"),r.__super__.initialize.apply(this,arguments)},r.prototype.getRenderData=function(){return{type:this.model.get("type"),model:this.model,clearance:this.getClearanceWithContacts(),makeURL:this.makeURL,possible_permissions:this.permissions(),t:t,isMicropub:this.isMicropub}},r.prototype.render=function(){return r.__super__.render.call(this),$(".email-hint").remove(),$(".modal-footer").prepend($("<span class='pull-left email-hint'>"+t("send email hint")+"</span>"))},r.prototype.renderContent=function(){return $("<p>Please wait</p>")},r.prototype.afterRender=function(){var e;return e=this.model.get("clearance")||[],this._checkToggleButtonState(e),this._configureTypeAhead(e),this._firstFocus(e),this.isMicropub()?(this.$(".public-url").hide(),$(".email-hint").hide(),void $(".micropub").show()):this.isPublicClearance()?(this.$(".public-url").show(),$(".email-hint").hide(),$(".micropub").hide()):(this.$(".public-url").hide(),$(".micropub").hide(),this.isPrivateClearance()?$(".email-hint").hide():$(".email-hint").show())},r.prototype._checkToggleButtonState=function(e){return this.isPrivateClearance?this.$("#share-private").addClass("toggled"):this.isPublicClearance?this.isMicropub()?this.$("#share-micropub").addClass("toggled"):this.$("#share-public").addClass("toggled"):void 0},r.prototype._configureTypeAhead=function(e){var t;return"object"!=typeof e||e.length>0?(t=this.$("#share-input"),c(t,this.onGuestAdded,this.typeaheadFilter)):void 0},r.prototype._firstFocus=function(e){return setTimeout(function(t){return function(){return t.isPublicClearance()?t.$("#public-url").focus().select():e.length>0?t.$("input#share-input").select():void 0}}(this),200)},r.prototype.refresh=function(){return this.$(".modal-body").html(this.template_content(this.getRenderData())),this.afterRender()},r.prototype.makePublic=function(){return null!=this.lastClearance?this.model.set({clearance:this.lastClearance}):this.model.set({clearance:"public"}),this.refresh()},r.prototype.makeMicropub=function(){return this.model.set({micropub:!0}),this.refresh()},r.prototype.makePrivate=function(){return this.isPublicClearance()?(this.lastClearance=this.model.get("clearance"),this.model.set({clearance:[]}),this.refresh()):void 0},r.prototype.makeURL=function(e){var t;return console.log("key : "+e),t=this.model.getPublicURL(),e&&(t+="?key="+e),e&&this.saveKey(e),t},r.prototype.typeaheadFilter=function(e){return!this.existsEmail(e.toString().split(";")[0])},r.prototype.existsEmail=function(e){return _.some(this.model.get("clearance"),function(t){return t.email===e})},r.prototype.getClearanceWithContacts=function(e){return null==e&&(e=this.model.get("clearance")||[]),"object"==typeof e&&(e=e.map(function(e){var t;return t=_.clone(e),t.contactid&&(t.contact=a.get(e.contactid)),t})),e},r.prototype.doSave=function(e,n){return u("PUT","clearance/"+this.model.id,this.saveData(),{error:function(){return o.error(t("server error occured"))},success:function(r){return function(i){return r.model.trigger("change",r.model),e?u("POST","clearance/"+r.model.id+"/send",n,{error:function(e,n){return-1!==e.responseText.indexOf("postfix-")?o.error(t("postfix error")):o.error(t("mail not sent"))},success:function(e){return r.$el.modal("hide")}}):r.$el.modal("hide")}}(this)})},r.prototype.saveData=function(){return{clearance:this.model.get("clearance")}},r.prototype.showLink=function(e){var n,r,i,o,s;return r=$(e.target).parents("li"),0===r.find(".linkshow").length?(i=$(e.currentTarget),o=i.prop("href"),r=$('<div class="linkshow">'),n=$("<label>").text(t("copy paste link")),s=$('<input type="text">').val(o),i.parents("li").append(r.append(n,s)),s.focus().select(),e.preventDefault()):r.find(".linkshow").remove(),!1},r.prototype.isPublicClearance=function(){return"public"===this.model.get("clearance")},r.prototype.isPrivateClearance=function(){var e;return e=this.model.get("clearance"),"object"==typeof e&&0===e.length},r.prototype.isMicropub=function(){return this.model.get("micropub")===!0},r.prototype.onAddClicked=function(){return this.onGuestAdded(this.$("#share-input").val())},r.prototype.onGuestAdded=function(e){var t,n,r,i,o,s,a;return a=e.split(";"),r=a[0],n=a[1],i=""===r||r.indexOf("@")<1,this.existsEmail(r)||i?null:(o=l(),s="r",t=this.isPublicClearance()?[]:this.model.get("clearance"),t.push({contactid:n,email:r,key:o,perm:s}),this.model.set({clearance:t}),this.refresh())},r.prototype.revoke=function(e){var t;return t=this.model.get("clearance").filter(function(t){return t.key!==e.currentTarget.dataset.key}),0===t.length?this.model.set({clearance:"public"}):this.model.set({clearance:t}),this.refresh()},r.prototype.changePerm=function(e){var t;return t=e.currentTarget,this.model.get("clearance").filter(function(e){return e.key===t.dataset.key})[0].perm=t.options[t.selectedIndex].value,this.refresh()},r.prototype.onNo=function(){var e,n,i,a;return e=this.model.get("clearance"),i=0!==s(e,this.initState).length,n=e.length!==this.initState.length,a=i||n,a?o.confirm(t("confirm"),t("share confirm save"),t("yes"),t("no"),function(e){return function(t){return t?r.__super__.onNo.apply(e,arguments):void 0}}(this)):r.__super__.onNo.apply(this,arguments)},r.prototype.onYes=function(){var e,n;return e=this.model.get("clearance"),n=0!==s(e,this.initState).length,this.$("#share-input").val()&&!n?o.confirm(t("confirm"),t("share forgot add"),t("no forgot"),t("yes forgot"),function(e){return function(t){return t?r.__super__.onYes.apply(e,arguments):void 0}}(this)):r.__super__.onYes.apply(this,arguments)},r.prototype.onClose=function(e){var n,r;return e?(n=s(this.model.get("clearance"),this.initState),n.length?(r=t("send mails question")+n.map(function(e){return e.email}).join(", "),o.confirm(t("modal send mails"),r,t("yes"),t("no"),function(e){return function(t){return e.doSave(t,n)}}(this))):this.doSave(!1)):this.model.set({clearance:this.initState})},r.prototype.indieAuth=function(){var e;return this.model.set({micropub:!0}),e={url:this.getMicropubURL,id:this.model.id},p("GET","clearance/indieauth",e,{error:function(e,n){return console.log("data : "+JSON.stringify(e)),console.log("response : "+JSON.stringify(n)),o.error(t(JSON.stringify(n)))},success:function(e){return function(e){return console.log("success data : "+JSON.stringify(e)),window.location.replace(e)}}(this)})},r.prototype.micropub=function(){return p("GET","clearance/photos",this.getKey(),{error:function(e,n){return o.error(t(JSON.stringify(n)))},success:function(e){return console.log("data : "+JSON.stringify(e)),console.log("micropub go"),p("GET","clearance/micropub",e,{error:function(e,n){return console.log("data : "+JSON.stringify(e)),console.log("response : "+JSON.stringify(n)),o.error(t(JSON.stringify(n)))},success:function(e){return function(e){return console.log("success !")}}(this)})}})},r.prototype.getMicropubURL=function(){return this.$("#micropub-input").val()},r.prototype.getKey=function(){return console.log("key : "+this.model.get("key")),{key:this.model.get("key")}},r.prototype.saveKey=function(e){return console.log("key saved : "+e),this.model.set({key:e})},r}(o)});